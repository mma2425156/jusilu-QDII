<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集思录QDII数据展示</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>集思录QDII数据</h1>
                <p class="text-muted small">数据更新时间: {{ update_time }}</p>
                <div id="refreshStatus" class="alert alert-info d-none mt-2 small">
                    <div id="statusMessage"></div>
                    <pre id="statusOutput" class="mt-2 mb-0 small" style="white-space: pre-wrap;"></pre>
                </div>
            </div>
            <div>
                <button id="mailConfigBtn" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#mailConfigModal">
                    邮件设置
                </button>
                <button id="refreshBtn" class="btn btn-primary">
                    <span id="refreshText">刷新数据</span>
                    <span id="refreshSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
        
        <form method="POST" class="mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="premium_min" class="form-label">T-1溢价率 ≥</label>
                    <input type="number" step="0.01" class="form-control" id="premium_min" name="premium_min" value="{{ premium_min }}">
                </div>
                <div class="col-md-4">
                    <label for="status_filter" class="form-label">申购状态</label>
                    <select class="form-select" id="status_filter" name="status_filter">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>全部</option>
                        <option value="open" {% if status_filter == 'open' %}selected{% endif %}>开放申购</option>
                        <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>暂停申购</option>
                        <option value="limited" {% if status_filter == 'limited' %}selected{% endif %}>限量申购</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">筛选</button>
                </div>
            </div>
        </form>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>来源</th>
                    <th>代码</th>
                    <th>名称</th>
                    <th>T-1溢价率</th>
                    <th>申购状态</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                {% for item in qdii_data %}
                <tr>
                    <td>{{ item.来源 }}</td>
                    <td>{{ item.代码 }}</td>
                    <td>{{ item.名称 }}</td>
                    <td>{{ item['T-1溢价率'] }}</td>
                    <td>{{ item.申购状态 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- 邮件设置模态框 -->
    <div class="modal fade" id="mailConfigModal" tabindex="-1" aria-labelledby="mailConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mailConfigModalLabel">邮件服务器配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="mailConfigForm">
                        <div class="mb-3">
                            <label for="smtpServer" class="form-label">SMTP服务器</label>
                            <input type="text" class="form-control" id="smtpServer" required>
                        </div>
                        <div class="mb-3">
                            <label for="smtpPort" class="form-label">SMTP端口</label>
                            <input type="number" class="form-control" id="smtpPort" required>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">邮箱账号</label>
                            <input type="email" class="form-control" id="username" required>
                            <div class="form-text">同时作为SMTP登录用户名和发件人邮箱</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="useSSL">
                            <label class="form-check-label" for="useSSL">使用SSL</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveMailConfig">保存配置</button>
                    <button type="button" class="btn btn-outline-primary" id="testMailConfig">测试配置</button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#taskConfigModal" 
                        onclick="$('#mailConfigModal').modal('hide')">
                        配置定时任务
                    </button>
                </div>
    </div>
</div>

<!-- 任务列表区域 -->
<div class="container mt-4">
    <h4>已保存的任务</h4>
    <div class="card">
        <div class="card-body">
            <table class="table table-hover" id="taskTable">
                <thead>
                    <tr>
                        <th>执行时间</th>
                        <th>收件人邮箱</th>
                        <th>筛选条件</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 任务列表将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 任务操作脚本 -->
<script>
$(document).ready(function() {
    // 加载任务列表
    function loadTasks() {
        $.get('/api/tasks', function(data) {
            if(data.status === 'success') {
                $('#taskTable tbody').empty();
                data.tasks.forEach(function(task) {
                    const conditions = JSON.parse(task.conditions);
                    const cronMap = {
                        '0 9 * * *': '每天上午9点',
                        '0 18 * * *': '每天下午6点',
                        '0 9 * * 1-5': '工作日早上9点',
                        '0 18 * * 1-5': '工作日下午6点',
                        '0 9 * * 1': '每周一早上9点'
                    };
                    
                    $('#taskTable tbody').append(`
                        <tr data-task-id="${task.id}">
                            <td>${cronMap[task.cron_expression] || task.cron_expression}</td>
                            <td>${task.recipients}</td>
                            <td>T-1溢价率 ≥ ${conditions.premium_min}<br>申购状态: ${conditions.status_filter}</td>
                            <td>${task.is_active ? '运行中' : '已停止'}</td>
                            <td>
                                <button class="btn btn-sm ${task.is_active ? 'btn-warning stop-task' : 'btn-success start-task'}">
                                    ${task.is_active ? '停止' : '运行'}
                                </button>
                                <button class="btn btn-sm btn-primary edit-task">修改</button>
                                <button class="btn btn-sm btn-info view-logs">日志</button>
                            </td>
                        </tr>
                    `);
                });
            }
        });
    }

    // 初始化加载任务列表
    loadTasks();

    // 操作按钮事件
    $('#taskTable').on('click', '.start-task, .stop-task', function() {
        const taskId = $(this).closest('tr').data('task-id');
        const isStart = $(this).hasClass('start-task');
        
        $.ajax({
            url: `/api/tasks/${taskId}/status`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ is_active: isStart }),
            success: function() {
                loadTasks(); // 刷新任务列表
                alert(`任务已${isStart ? '启动' : '停止'}`);
            },
            error: function(xhr) {
                alert(`操作失败: ${xhr.responseJSON?.message || '未知错误'}`);
            }
        });
    });

    $('#taskTable').on('click', '.edit-task', function() {
        const taskId = $(this).closest('tr').data('task-id');
        // 加载任务配置到模态框
                $.get(`/api/tasks?id=${taskId}`, function(data) {
                    if(data.status === 'success') {
                        const task = data.tasks[0];
                        const conditions = JSON.parse(task.conditions);
                        
                        // 解析cron表达式
                        const cronParts = task.cron_expression.split(' ');
                        const minutes = cronParts[0];
                        const hours = cronParts[1];
                        const days = cronParts[4];
                        
                        // 设置时间
                        $('#executionTime').val(`${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`);
                        
                        // 设置星期选择
                        if(days === '*') {
                            $('#selectAllDays').prop('checked', true);
                            $('input[name="weekdays"]').prop('checked', true);
                        } else {
                            const selectedDays = days.split(',');
                            selectedDays.forEach(day => {
                                $(`input[name="weekdays"][value="${day}"]`).prop('checked', true);
                            });
                        }
                        
                        // 填充其他字段
                        $('#recipients').val(task.recipients);
                        $('#taskPremiumMin').val(conditions.premium_min);
                        $('#taskStatusFilter').val(conditions.status_filter);
                
                // 显示模态框
                $('#taskConfigModal').modal('show');
            }
        });
    });

    $('#taskTable').on('click', '.view-logs', function() {
        const taskId = $(this).closest('tr').data('task-id');
        // 查看任务日志
        $.get(`/api/tasks/${taskId}/logs`, function(data) {
            if(data.status === 'success') {
                let logContent = '<table class="table"><thead><tr><th>执行时间</th><th>状态</th><th>筛选结果</th></tr></thead><tbody>';
                
                data.logs.forEach(log => {
                    logContent += `
                        <tr>
                            <td>${log.run_time}</td>
                            <td>${log.status}</td>
                            <td>${log.filtered_count}条数据</td>
                        </tr>
                    `;
                });
                
                logContent += '</tbody></table>';
                
                $('#logContent').html(logContent);
                $('#logModal').modal('show');
            }
        });
    });
    
    // 日志模态框
    $('body').append(`
        <div class="modal fade" id="logModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">任务执行日志</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="logContent">
                        <!-- 日志内容将通过JavaScript动态加载 -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    `);
});
</script>
    </div>

    <!-- 定时任务配置模态框 -->
    <div class="modal fade" id="taskConfigModal" tabindex="-1" aria-labelledby="taskConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskConfigModalLabel">定时任务配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskConfigForm">
                        <div class="mb-3">
                            <label class="form-label">执行时间</label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="small mb-1">选择星期</label>
                                    <div class="btn-group-toggle" data-toggle="buttons">
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="1"> 周一
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="2"> 周二
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="3"> 周三
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="4"> 周四
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="5"> 周五
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="6"> 周六
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" name="weekdays" value="0"> 周日
                                        </label>
                                        <label class="btn btn-outline-primary btn-sm mb-1">
                                            <input type="checkbox" id="selectAllDays"> 每天
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="executionTime" class="small mb-1">具体时间</label>
                                    <input type="time" class="form-control" id="executionTime" value="09:00" required>
                                </div>
                            </div>
                                <option value="custom">自定义...</option>
                            </select>
                            <div class="form-text mt-1">选择预设时间或<a href="https://crontab.guru/" target="_blank">生成自定义表达式</a></div>
                        </div>
                        <div class="mb-3">
                            <label for="recipients" class="form-label">收件人邮箱</label>
                            <textarea class="form-control" id="recipients" rows="3" 
                                placeholder="例如: user1@example.com, user2@example.com (多个邮箱用英文逗号分隔)" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskPremiumMin" class="form-label">T-1溢价率 ≥</label>
                            <input type="number" step="0.01" class="form-control" id="taskPremiumMin" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskStatusFilter" class="form-label">申购状态</label>
                            <select class="form-select" id="taskStatusFilter" required>
                                <option value="all">全部</option>
                                <option value="open">开放申购</option>
                                <option value="closed">暂停申购</option>
                                <option value="limited">限量申购</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary me-auto" onclick="$('#taskConfigModal').modal('hide'); $('#mailConfigModal').modal('show')">
                        &larr; 返回邮件配置
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-outline-primary" id="testTaskConfig">测试配置</button>
                    <button type="button" class="btn btn-primary" id="saveTaskConfig">保存任务</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 加载邮件配置
        function loadMailConfig() {
            $.get('/api/mail/config', function(response) {
                if (response.status === 'success') {
                    $('#smtpServer').val(response.config.smtp_server);
                    $('#smtpPort').val(response.config.smtp_port);
                    $('#username').val(response.config.username);
                    $('#password').val(response.config.password);
                    $('#senderEmail').val(response.config.sender_email);
                    $('#useSSL').prop('checked', response.config.use_ssl);
                }
            }).fail(function() {
                alert('加载邮件配置失败');
            });
        }

        // 测试定时任务配置
        function testTaskConfig() {
            const taskData = {
                cron_expression: $('#cronExpression').val(),
                recipients: $('#recipients').val().split(',').map(e => e.trim()),
                premium_min: parseFloat($('#taskPremiumMin').val()),
                status_filter: $('#taskStatusFilter').val()
            };

            $.ajax({
                url: '/api/tasks/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(taskData),
                success: function(response) {
                    const msg = `测试成功！\n\n已发送邮件至: ${taskData.recipients.join(', ')}\n\n` +
                               `筛选结果: ${response.filtered_count}条符合条件的数据`;
                    alert(msg);
                },
                error: function(xhr) {
                    alert('测试失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        }

        // 保存定时任务配置
        function saveTaskConfig() {
            // 生成cron表达式
            const timeParts = $('#executionTime').val().split(':');
            const hours = timeParts[0];
            const minutes = timeParts[1];
            
            const weekdays = [];
            $('input[name="weekdays"]:checked').each(function() {
                if($(this).attr('id') !== 'selectAllDays') {
                    weekdays.push($(this).val());
                }
            });
            
            let cronExpression;
            if($('#selectAllDays').is(':checked')) {
                cronExpression = `${minutes} ${hours} * * *`;
            } else if(weekdays.length > 0) {
                cronExpression = `${minutes} ${hours} * * ${weekdays.join(',')}`;
            } else {
                alert('请至少选择一天');
                return;
            }
            
            const taskData = {
                cron_expression: cronExpression,
                recipients: $('#recipients').val().split(',').map(e => e.trim()),
                premium_min: parseFloat($('#taskPremiumMin').val()),
                status_filter: $('#taskStatusFilter').val()
            };

            $.ajax({
                url: '/api/tasks',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(taskData),
                success: function() {
                    alert('定时任务保存成功');
                    $('#taskConfigModal').modal('hide');
                },
                error: function(xhr) {
                    alert('保存失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        }

        $(document).ready(function() {
            // 全选/取消全选
            $('#selectAllDays').change(function() {
                $('input[name="weekdays"]').prop('checked', $(this).is(':checked'));
            });
            
            // 如果手动选择所有天，自动勾选"每天"
            $('input[name="weekdays"]').change(function() {
                if($('input[name="weekdays"]:checked').length === 7) {
                    $('#selectAllDays').prop('checked', true);
                } else {
                    $('#selectAllDays').prop('checked', false);
                }
            });
            
            // 保存定时任务按钮事件
            $('#saveTaskConfig').click(saveTaskConfig);
            // 测试配置按钮事件
            $('#testTaskConfig').click(testTaskConfig);
            // 初始化邮件配置模态框
            $('#mailConfigModal').on('show.bs.modal', loadMailConfig);
            
            // 保存邮件配置
            $('#saveMailConfig').click(function() {
                const config = {
                    smtp_server: $('#smtpServer').val(),
                    smtp_port: parseInt($('#smtpPort').val()),
                    username: $('#username').val(),
                    password: $('#password').val(),
                    sender_email: $('#senderEmail').val(),
                    use_ssl: $('#useSSL').is(':checked')
                };
                
                $.ajax({
                    url: '/api/mail/config',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(config),
                    success: function() {
                        alert('邮件配置保存成功');
                        $('#mailConfigModal').modal('hide');
                    },
                    error: function(xhr) {
                        alert('保存失败: ' + (xhr.responseJSON?.message || '未知错误'));
                    }
                });
            });
            
            // 测试邮件配置
            $('#testMailConfig').click(function() {
                const email = prompt('请输入测试收件人邮箱:');
                if (!email) return;
                
                $.ajax({
                    url: '/api/mail/test',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ recipient: email }),
                    success: function() {
                        alert('测试邮件发送成功，请检查收件箱');
                    },
                    error: function(xhr) {
                        alert('测试失败: ' + (xhr.responseJSON?.message || '未知错误'));
                    }
                });
            });
            let cooldown = 0;
            let cooldownInterval;
            
            function updateButtonState() {
                const btn = $('#refreshBtn');
                const text = $('#refreshText');
                
                if (cooldown > 0) {
                    btn.prop('disabled', true);
                    text.text(`请等待 ${cooldown}秒`);
                    cooldown--;
                } else {
                    btn.prop('disabled', false);
                    text.text('刷新数据');
                    clearInterval(cooldownInterval);
                }
            }
            
            $('#refreshBtn').click(function() {
                const btn = $(this);
                const spinner = $('#refreshSpinner');
                const text = $('#refreshText');
                
                btn.prop('disabled', true).removeClass('btn-primary').addClass('btn-secondary');
                text.text('30秒后自动刷新');
                spinner.removeClass('d-none');
                cooldown = 30;
                
                // 启动倒计时
                cooldownInterval = setInterval(function() {
                    if (cooldown > 0) {
                        text.text(cooldown + '秒后自动刷新');
                        cooldown--;
                    } else {
                        clearInterval(cooldownInterval);
                        location.reload(true); // 强制刷新整个页面
                    }
                }, 1000);

                // 异步刷新数据
                const premium_min_val = $('#premium_min').val();
                const status_filter_val = $('#status_filter').val();

                $.ajax({
                    url: '/refresh',
                    method: 'POST',
                    data: {
                        premium_min: premium_min_val,
                        status_filter: status_filter_val
                    },
                    success: function(response) {
                        const statusAlert = $('#refreshStatus');
                        const statusMessage = $('#statusMessage');
                        const statusOutput = $('#statusOutput');
                        
                        statusAlert.removeClass('d-none alert-danger').addClass('alert-info');
                        statusMessage.html(`<strong>${response.message}</strong> - ${response.timestamp}`);
                        statusOutput.text(response.output || '无详细输出');
                        
                        if (response.status === 'success') {
                            let html = '';
                            response.data.forEach(item => {
                                html += `<tr>
                                    <td>${item.来源}</td>
                                    <td>${item.代码}</td>
                                    <td>${item.名称}</td>
                                    <td>${item['T-1溢价率']}</td>
                                    <td>${item.申购状态}</td>
                                </tr>`;
                            });
                            $('#dataTableBody').html(html);
                        }
                    },
                    error: function(xhr) {
                        const response = xhr.responseJSON;
                        const statusAlert = $('#refreshStatus');
                        const statusMessage = $('#statusMessage');
                        const statusOutput = $('#statusOutput');
                        
                        statusAlert.removeClass('d-none alert-info').addClass('alert-danger');
                        statusMessage.html(`<strong>刷新失败</strong> - ${new Date().toLocaleString()}`);
                        statusOutput.text(response?.message || '未知错误');
                    }
                });
            });
        });
    </script>
</body>
</html>
