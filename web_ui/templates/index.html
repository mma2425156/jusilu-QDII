<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集思录QDII数据展示</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>集思录QDII数据</h1>
                <p class="text-muted small">数据更新时间: {{ update_time }}</p>
                <div id="refreshStatus" class="alert alert-info d-none mt-2 small">
                    <div id="statusMessage"></div>
                    <pre id="statusOutput" class="mt-2 mb-0 small" style="white-space: pre-wrap;"></pre>
                </div>
            </div>
            <div>
                <button id="mailConfigBtn" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#mailConfigModal">
                    邮件设置
                </button>
                <button id="refreshBtn" class="btn btn-primary">
                    <span id="refreshText">刷新数据</span>
                    <span id="refreshSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
        
        <form method="POST" class="mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="premium_min" class="form-label">T-1溢价率 ≥</label>
                    <input type="number" step="0.01" class="form-control" id="premium_min" name="premium_min" value="{{ premium_min }}">
                </div>
                <div class="col-md-4">
                    <label for="status_filter" class="form-label">申购状态</label>
                    <select class="form-select" id="status_filter" name="status_filter">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>全部</option>
                        <option value="open" {% if status_filter == 'open' %}selected{% endif %}>开放申购</option>
                        <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>暂停申购</option>
                        <option value="limited" {% if status_filter == 'limited' %}selected{% endif %}>限量申购</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">筛选</button>
                </div>
            </div>
        </form>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>来源</th>
                    <th>代码</th>
                    <th>名称</th>
                    <th>T-1溢价率</th>
                    <th>申购状态</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                {% for item in qdii_data %}
                <tr>
                    <td>{{ item.来源 }}</td>
                    <td>{{ item.代码 }}</td>
                    <td>{{ item.名称 }}</td>
                    <td>{{ item['T-1溢价率'] }}</td>
                    <td>{{ item.申购状态 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- 邮件设置模态框 -->
    <div class="modal fade" id="mailConfigModal" tabindex="-1" aria-labelledby="mailConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mailConfigModalLabel">邮件服务器配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="mailConfigForm">
                        <div class="mb-3">
                            <label for="smtpServer" class="form-label">SMTP服务器</label>
                            <input type="text" class="form-control" id="smtpServer" required>
                        </div>
                        <div class="mb-3">
                            <label for="smtpPort" class="form-label">SMTP端口</label>
                            <input type="number" class="form-control" id="smtpPort" required>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">邮箱账号</label>
                            <input type="email" class="form-control" id="username" required>
                            <div class="form-text">同时作为SMTP登录用户名和发件人邮箱</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="useSSL">
                            <label class="form-check-label" for="useSSL">使用SSL</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveMailConfig">保存配置</button>
                    <button type="button" class="btn btn-outline-primary" id="testMailConfig">测试配置</button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#taskConfigModal" 
                        onclick="$('#mailConfigModal').modal('hide')">
                        配置定时任务
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 定时任务配置模态框 -->
    <div class="modal fade" id="taskConfigModal" tabindex="-1" aria-labelledby="taskConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskConfigModalLabel">定时任务配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body row">
                    <div class="col-md-6">
                        <form id="taskConfigForm">
                            <div class="mb-3">
                                <label class="form-label">执行时间</label>
                                <div class="mb-3">
                                    <div class="d-flex gap-2 align-items-center mb-2">
                                        <input type="time" class="form-control" id="executionTime" value="09:00" required>
                                        <span>每</span>
                                    </div>
                                    <div class="btn-group d-flex flex-wrap" role="group">
                                        <input type="checkbox" class="btn-check" id="weekday1" name="weekdays" value="1" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday1">周一</label>
                                        
                                        <input type="checkbox" class="btn-check" id="weekday2" name="weekdays" value="2" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday2">周二</label>
                                        
                                        <input type="checkbox" class="btn-check" id="weekday3" name="weekdays" value="3" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday3">周三</label>
                                        
                                        <input type="checkbox" class="btn-check" id="weekday4" name="weekdays" value="4" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday4">周四</label>
                                        
                                        <input type="checkbox" class="btn-check" id="weekday5" name="weekdays" value="5" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday5">周五</label>
                                        
                                        <input type="checkbox" class="btn-check" id="weekday6" name="weekdays" value="6" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday6">周六</label>
                                        
                                        <input type="checkbox" class="btn-check" id="weekday0" name="weekdays" value="0" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="weekday0">周日</label>
                                    </div>
                                    <div class="mt-2">
                                        <input type="checkbox" class="btn-check" id="selectAllDays" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="selectAllDays">每天</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="recipients" class="form-label">收件人邮箱</label>
                                <textarea class="form-control" id="recipients" rows="2" 
                                    placeholder="例如: user1@example.com, user2@example.com (多个邮箱用英文逗号分隔)" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="taskPremiumMin" class="form-label">T-1溢价率 ≥</label>
                                <input type="number" step="0.01" class="form-control" id="taskPremiumMin" required>
                            </div>
                            <div class="mb-3">
                                <label for="taskStatusFilter" class="form-label">申购状态</label>
                                <select class="form-select" id="taskStatusFilter" required>
                                    <option value="all">全部</option>
                                    <option value="open">开放申购</option>
                                    <option value="closed">暂停申购</option>
                                    <option value="limited">限量申购</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">已保存的任务</h6>
                            </div>
                            <div class="card-body p-0" style="max-height: 350px; overflow-y: auto;">
                                <table class="table table-hover m-0" id="taskTable">
                                    <thead>
                                        <tr class="table-light">
                                            <th>执行时间</th>
                                            <th>筛选条件</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 任务列表将通过JavaScript动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary me-auto" onclick="$('#taskConfigModal').modal('hide'); $('#mailConfigModal').modal('show')">
                        &larr; 返回邮件配置
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-outline-primary" id="testTaskConfig">测试配置</button>
                    <button type="button" class="btn btn-primary" id="saveTaskConfig">保存任务</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志模态框 -->
    <div class="modal fade" id="logModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">任务执行日志</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="logContent">
                    <!-- 日志内容将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 加载邮件配置
        function loadMailConfig() {
            // 显示加载状态
            $('#mailConfigForm').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="text-muted">正在加载邮件配置...</p>
                </div>
            `);
            
            $.get('/api/mail/config', function(response) {
                if (response.status === 'success') {
                    // 重新加载表单
                    $('#mailConfigForm').html(`
                        <div class="mb-3">
                            <label for="smtpServer" class="form-label">SMTP服务器</label>
                            <input type="text" class="form-control" id="smtpServer" value="${response.config.smtp_server || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label for="smtpPort" class="form-label">SMTP端口</label>
                            <input type="number" class="form-control" id="smtpPort" value="${response.config.smtp_port || '465'}" required>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">邮箱账号</label>
                            <input type="email" class="form-control" id="username" value="${response.config.username || ''}" required>
                            <div class="form-text">同时作为SMTP登录用户名和发件人邮箱</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" value="${response.config.password ? '******' : ''}" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="useSSL" ${response.config.use_ssl ? 'checked' : ''}>
                            <label class="form-check-label" for="useSSL">使用SSL</label>
                        </div>
                    `);
                }
            }).fail(function() {
                $('#mailConfigForm').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>加载邮件配置失败
                        <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadMailConfig()">重试</button>
                    </div>
                `);
            });
        }

        // 初始化邮件配置模态框
        $('#mailConfigModal').on('show.bs.modal', loadMailConfig);
        
        // 防刷机制 - 保存邮件配置
        let saveMailCooldown = false;
        $('#saveMailConfig').click(function() {
            if (saveMailCooldown) return;
            
            saveMailCooldown = true;
            setTimeout(() => saveMailCooldown = false, 2000);
            
            const btn = $(this);
            const originalHtml = btn.html();
            btn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>保存中...').prop('disabled', true);
            
            const config = {
                smtp_server: $('#smtpServer').val(),
                smtp_port: parseInt($('#smtpPort').val()),
                username: $('#username').val(),
                password: $('#password').val() === '******' ? '' : $('#password').val(),
                sender_email: $('#username').val(),
                use_ssl: $('#useSSL').is(':checked')
            };
            
            $.ajax({
                url: '/api/mail/config',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function() {
                    btn.html(originalHtml).prop('disabled', false);
                    
                    // 显示成功消息
                    const toast = `
                        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-success text-white">
                                    <strong class="me-auto">操作成功</strong>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                </div>
                                <div class="toast-body">
                                    邮件配置已成功保存
                                </div>
                            </div>
                        </div>
                    `;
                    $('body').append(toast);
                    setTimeout(() => $('.toast').parent().remove(), 3000);
                    
                    $('#mailConfigModal').modal('hide');
                },
                error: function(xhr) {
                    btn.html(originalHtml).prop('disabled', false);
                    alert('保存失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        });
        
        // 防刷机制 - 测试邮件配置
        let testMailCooldown = false;
        $('#testMailConfig').click(function() {
            if (testMailCooldown) return;
            
            testMailCooldown = true;
            setTimeout(() => testMailCooldown = false, 3000);
            
            const btn = $(this);
            const originalHtml = btn.html();
            
            const email = prompt('请输入测试收件人邮箱:');
            if (!email) {
                testMailCooldown = false;
                return;
            }
            
            btn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>测试中...').prop('disabled', true);
            
            $.ajax({
                url: '/api/mail/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ recipient: email }),
                success: function() {
                    btn.html(originalHtml).prop('disabled', false);
                    
                    // 显示成功消息
                    const modal = `
                        <div class="modal fade" id="mailTestModal" tabindex="-1">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>发送成功</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>测试邮件已发送至：</p>
                                        <div class="alert alert-light mb-0">
                                            ${email}
                                        </div>
                                        <p class="text-muted small mt-3 mb-0">请检查收件箱查看邮件内容</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('body').append(modal);
                    const testModal = new bootstrap.Modal(document.getElementById('mailTestModal'));
                    testModal.show();
                    
                    // 关闭后移除
                    $('#mailTestModal').on('hidden.bs.modal', function () {
                        $(this).remove();
                    });
                },
                error: function(xhr) {
                    btn.html(originalHtml).prop('disabled', false);
                    alert('测试失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        });
        
        // 防刷机制 - 刷新数据
        let refreshCooldown = 0;
        let refreshCooldownInterval;
        
        function updateRefreshButtonState() {
            const btn = $('#refreshBtn');
            const text = $('#refreshText');
            const spinner = $('#refreshSpinner');
            
            if (refreshCooldown > 0) {
                btn.prop('disabled', true)
                   .removeClass('btn-primary')
                   .addClass('btn-secondary');
                text.text(`请等待 ${refreshCooldown}秒`);
                refreshCooldown--;
            } else {
                btn.prop('disabled', false)
                   .removeClass('btn-secondary')
                   .addClass('btn-primary');
                text.text('刷新数据');
                spinner.addClass('d-none');
                clearInterval(refreshCooldownInterval);
            }
        }
        
        $('#refreshBtn').click(function() {
            if (refreshCooldown > 0) return;
            
            const btn = $(this);
            const spinner = $('#refreshSpinner');
            const text = $('#refreshText');
            
            btn.prop('disabled', true)
               .removeClass('btn-primary')
               .addClass('btn-secondary');
            text.text('数据刷新中...');
            spinner.removeClass('d-none');
            
            // 设置冷却时间
            refreshCooldown = 30;
            
            // 异步刷新数据
            const premium_min_val = $('#premium_min').val();
            const status_filter_val = $('#status_filter').val();
            
            $.ajax({
                url: '/refresh',
                method: 'POST',
                data: {
                    premium_min: premium_min_val,
                    status_filter: status_filter_val
                },
                success: function(response) {
                    const statusAlert = $('#refreshStatus');
                    const statusMessage = $('#statusMessage');
                    const statusOutput = $('#statusOutput');
                    
                    statusAlert.removeClass('d-none alert-danger').addClass('alert-info');
                    statusMessage.html(`<strong>${response.message}</strong> - ${response.timestamp}`);
                    statusOutput.text(response.output || '无详细输出');
                    
                    // 显示成功反馈
                    const toast = `
                        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-success text-white">
                                    <strong class="me-auto">刷新成功</strong>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                </div>
                                <div class="toast-body">
                                    数据已成功更新，发现 ${response.data.length} 条符合条件的数据
                                </div>
                            </div>
                        </div>
                    `;
                    $('body').append(toast);
                    setTimeout(() => $('.toast').parent().remove(), 3000);
                    
                    if (response.status === 'success') {
                        let html = '';
                        response.data.forEach(item => {
                            html += `<tr>
                                <td>${item.来源}</td>
                                <td>${item.代码}</td>
                                <td>${item.名称}</td>
                                <td>${item['T-1溢价率']}</td>
                                <td>${item.申购状态}</td>
                            </tr>`;
                        });
                        $('#dataTableBody').html(html);
                    }
                    
                    // 启动倒计时
                    text.text(`请等待 ${refreshCooldown}秒`);
                    refreshCooldownInterval = setInterval(updateRefreshButtonState, 1000);
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    const statusAlert = $('#refreshStatus');
                    const statusMessage = $('#statusMessage');
                    const statusOutput = $('#statusOutput');
                    
                    statusAlert.removeClass('d-none alert-info').addClass('alert-danger');
                    statusMessage.html(`<strong>刷新失败</strong> - ${new Date().toLocaleString()}`);
                    statusOutput.text(response?.message || '未知错误');
                    
                    // 启动倒计时
                    text.text(`请等待 ${refreshCooldown}秒`);
                    refreshCooldownInterval = setInterval(updateRefreshButtonState, 1000);
                }
            });
        });

        // 加载任务列表
        function loadTasks() {
            $.get('/api/tasks', function(data) {
                if(data.status === 'success') {
                    $('#taskTable tbody').empty();
                    data.tasks.forEach(function(task) {
                        const conditions = JSON.parse(task.conditions);
                        
                        // 格式化执行时间，更易读
                        let displayTime = "";
                        try {
                            const cronParts = task.cron_expression.split(' ');
                            const minutes = cronParts[0];
                            const hours = cronParts[1];
                            const days = cronParts[4];
                            
                            const time = `${hours}:${minutes.padStart(2, '0')}`;
                            
                            if (days === '*') {
                                displayTime = `每天 ${time}`;
                            } else if (days === '1,2,3,4,5') {
                                displayTime = `工作日 ${time}`;
                            } else {
                                const dayNames = {
                                    '0': '周日', '1': '周一', '2': '周二',
                                    '3': '周三', '4': '周四', '5': '周五', '6': '周六'
                                };
                                const dayList = days.split(',').map(d => dayNames[d]).join('、');
                                displayTime = `${dayList} ${time}`;
                            }
                        } catch (e) {
                            displayTime = task.cron_expression;
                        }
                        
                        $('#taskTable tbody').append(`
                            <tr data-task-id="${task.id}">
                                <td>${displayTime}</td>
                                <td>溢价率≥${conditions.premium_min}<br>${getStatusText(conditions.status_filter)}</td>
                                <td>
                                    <span class="badge ${task.is_active ? 'bg-success' : 'bg-secondary'}">
                                        ${task.is_active ? '运行中' : '已停止'}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-sm ${task.is_active ? 'btn-warning stop-task' : 'btn-success start-task'}" 
                                                data-bs-toggle="tooltip" title="${task.is_active ? '停止任务' : '启动任务'}">
                                            <i class="fas fa-${task.is_active ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary edit-task" data-bs-toggle="tooltip" title="编辑任务">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info view-logs" data-bs-toggle="tooltip" title="查看日志">
                                            <i class="fas fa-list"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-task" data-bs-toggle="tooltip" title="删除任务">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                    
                    // 如果没有任务，显示提示信息
                    if (data.tasks.length === 0) {
                        $('#taskTable tbody').html(`
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle me-2"></i>暂无保存的任务
                                </td>
                            </tr>
                        `);
                    }
                    
                    // 初始化工具提示
                    $('[data-bs-toggle="tooltip"]').tooltip();
                }
            });
        }
        
        // 获取状态文本
        function getStatusText(statusFilter) {
            const statusMap = {
                'all': '全部状态',
                'open': '仅开放申购',
                'limited': '仅限量申购',
                'closed': '仅暂停申购'
            };
            return statusMap[statusFilter] || statusFilter;
        }

        // 初始化加载任务列表
        loadTasks();
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 操作按钮事件
        $('#taskTable').on('click', '.start-task, .stop-task', function() {
            const btn = $(this);
            const taskId = btn.closest('tr').data('task-id');
            const isStart = btn.hasClass('start-task');
            
            // 显示加载状态
            const originalHtml = btn.html();
            btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>')
               .prop('disabled', true);
            
            $.ajax({
                url: `/api/tasks/${taskId}/status`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ is_active: isStart }),
                success: function() {
                    // 显示成功反馈
                    const toast = `
                        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-${isStart ? 'success' : 'warning'} text-white">
                                    <strong class="me-auto">操作成功</strong>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                </div>
                                <div class="toast-body">
                                    任务已${isStart ? '启动' : '停止'}
                                </div>
                            </div>
                        </div>
                    `;
                    $('body').append(toast);
                    setTimeout(() => $('.toast').parent().remove(), 3000);
                    
                    // 重新加载任务列表
                    loadTasks();
                },
                error: function(xhr) {
                    // 恢复按钮状态
                    btn.html(originalHtml).prop('disabled', false);
                    
                    // 显示错误信息
                    alert(`操作失败: ${xhr.responseJSON?.message || '未知错误'}`);
                }
            });
        });

        // 编辑任务事件
        $('#taskTable').on('click', '.edit-task', function() {
            const taskId = $(this).closest('tr').data('task-id');
            
            // 显示加载状态
            const loadingHtml = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="text-muted">正在加载任务信息...</p>
                </div>
            `;
            $('#taskConfigForm').closest('.col-md-6').html(loadingHtml);
            $('#taskConfigModal').modal('show');
            
            // 加载任务配置
            $.get(`/api/tasks?id=${taskId}`, function(data) {
                if(data.status === 'success') {
                    const task = data.tasks[0];
                    const conditions = JSON.parse(task.conditions);
                    
                    // 解析cron表达式
                    const cronParts = task.cron_expression.split(' ');
                    const minutes = cronParts[0];
                    const hours = cronParts[1];
                    const days = cronParts[4];
                    
                    // 重新加载表单内容
                    $('#taskConfigForm').closest('.col-md-6').load(location.href + ' #taskConfigForm', function() {
                        // 设置时间
                        $('#executionTime').val(`${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`);
                        
                        // 设置星期选择
                        if(days === '*') {
                            $('#selectAllDays').prop('checked', true);
                            $('input[name="weekdays"]').prop('checked', true);
                        } else {
                            const selectedDays = days.split(',');
                            selectedDays.forEach(day => {
                                $(`#weekday${day}`).prop('checked', true);
                            });
                        }
                        
                        // 填充其他字段
                        $('#recipients').val(task.recipients);
                        $('#taskPremiumMin').val(conditions.premium_min);
                        $('#taskStatusFilter').val(conditions.status_filter);
                        
                        // 重新绑定事件
                        bindFormEvents();
                    });
                }
            });
        });

        // 查看日志事件
        $('#taskTable').on('click', '.view-logs', function() {
            const taskId = $(this).closest('tr').data('task-id');
            
            // 显示加载中
            $('#logContent').html(`
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="text-muted">正在加载日志数据...</p>
                </div>
            `);
            $('#logModal').modal('show');
            
            // 查看任务日志
            $.get(`/api/tasks/${taskId}/logs`, function(data) {
                if(data.status === 'success') {
                    if (data.logs.length === 0) {
                        $('#logContent').html(`
                            <div class="text-center py-5">
                                <i class="fas fa-info-circle text-info fa-3x mb-3"></i>
                                <p class="text-muted">暂无执行日志记录</p>
                            </div>
                        `);
                        return;
                    }
                    
                    let logContent = `
                        <table class="table table-hover">
                            <thead>
                                <tr class="table-light">
                                    <th>执行时间</th>
                                    <th>状态</th>
                                    <th>筛选结果</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.logs.forEach(log => {
                        const time = new Date(log.run_time);
                        const formattedTime = time.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        
                        logContent += `
                            <tr>
                                <td>${formattedTime}</td>
                                <td>
                                    <span class="badge ${log.status === 'executed' ? 'bg-success' : 'bg-danger'}">
                                        ${log.status === 'executed' ? '执行成功' : '执行失败'}
                                    </span>
                                </td>
                                <td>${log.filtered_count}条数据</td>
                            </tr>
                        `;
                    });
                    
                    logContent += '</tbody></table>';
                    
                    $('#logContent').html(logContent);
                }
            });
        });
        
        // 删除任务事件
        $('#taskTable').on('click', '.delete-task', function() {
            const btn = $(this);
            const taskId = btn.closest('tr').data('task-id');
            
            if (confirm('确定要删除这个任务吗？此操作不可恢复。')) {
                // 显示加载状态
                const originalHtml = btn.html();
                btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>')
                   .prop('disabled', true);
                   
                $.ajax({
                    url: `/api/tasks/${taskId}`,
                    method: 'DELETE',
                    success: function() {
                        // 动画效果移除行
                        btn.closest('tr').fadeOut(300, function() {
                            $(this).remove();
                            // 如果没有任务了，显示空提示
                            if ($('#taskTable tbody tr').length === 0) {
                                $('#taskTable tbody').html(`
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">
                                            <i class="fas fa-info-circle me-2"></i>暂无保存的任务
                                        </td>
                                    </tr>
                                `);
                            }
                        });
                        
                        // 显示成功消息
                        const toast = `
                            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
                                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                    <div class="toast-header bg-danger text-white">
                                        <strong class="me-auto">操作成功</strong>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                    </div>
                                    <div class="toast-body">
                                        任务已成功删除
                                    </div>
                                </div>
                            </div>
                        `;
                        $('body').append(toast);
                        setTimeout(() => $('.toast').parent().remove(), 3000);
                    },
                    error: function(xhr) {
                        // 恢复按钮状态
                        btn.html(originalHtml).prop('disabled', false);
                        
                        // 显示错误信息
                        alert(`删除失败: ${xhr.responseJSON?.message || '未知错误'}`);
                    }
                });
            }
        });
        
        // 绑定表单事件
        function bindFormEvents() {
            // 全选/取消全选
            $('#selectAllDays').change(function() {
                $('input[name="weekdays"]').prop('checked', $(this).is(':checked'));
            });
            
            // 如果手动选择所有天，自动勾选"每天"
            $('input[name="weekdays"]').change(function() {
                if($('input[name="weekdays"]:checked').length === 7) {
                    $('#selectAllDays').prop('checked', true);
                } else {
                    $('#selectAllDays').prop('checked', false);
                }
            });
        }
        
        // 初始绑定表单事件
        bindFormEvents();
        
        // 防刷机制 - 保存任务配置
        let saveTaskCooldown = false;
        $('#saveTaskConfig').click(function() {
            if (saveTaskCooldown) return;
            
            saveTaskCooldown = true;
            setTimeout(() => saveTaskCooldown = false, 2000);
            
            const btn = $(this);
            const originalHtml = btn.html();
            btn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>保存中...').prop('disabled', true);
            
            // 生成cron表达式
            const timeParts = $('#executionTime').val().split(':');
            const hours = timeParts[0];
            const minutes = timeParts[1];
            
            const weekdays = [];
            $('input[name="weekdays"]:checked').each(function() {
                if($(this).attr('id') !== 'selectAllDays') {
                    weekdays.push($(this).val());
                }
            });
            
            let cronExpression;
            if($('#selectAllDays').is(':checked')) {
                cronExpression = `${minutes} ${hours} * * *`;
            } else if(weekdays.length > 0) {
                cronExpression = `${minutes} ${hours} * * ${weekdays.join(',')}`;
            } else {
                alert('请至少选择一天');
                btn.html(originalHtml).prop('disabled', false);
                saveTaskCooldown = false;
                return;
            }
            
            const taskData = {
                cron_expression: cronExpression,
                recipients: $('#recipients').val().split(',').map(e => e.trim()),
                premium_min: parseFloat($('#taskPremiumMin').val()),
                status_filter: $('#taskStatusFilter').val()
            };
            
            $.ajax({
                url: '/api/tasks',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(taskData),
                success: function() {
                    // 重新加载任务列表
                    loadTasks();
                    
                    // 显示成功消息
                    const toast = `
                        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-success text-white">
                                    <strong class="me-auto">操作成功</strong>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                </div>
                                <div class="toast-body">
                                    定时任务已成功保存
                                </div>
                            </div>
                        </div>
                    `;
                    $('body').append(toast);
                    setTimeout(() => $('.toast').parent().remove(), 3000);
                    
                    // 关闭模态框
                    $('#taskConfigModal').modal('hide');
                    btn.html(originalHtml).prop('disabled', false);
                },
                error: function(xhr) {
                    btn.html(originalHtml).prop('disabled', false);
                    alert('保存失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        });
        
        // 防刷机制 - 测试任务配置
        let testTaskCooldown = false;
        $('#testTaskConfig').click(function() {
            if (testTaskCooldown) return;
            
            testTaskCooldown = true;
            setTimeout(() => testTaskCooldown = false, 3000);
            
            const btn = $(this);
            const originalHtml = btn.html();
            btn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>测试中...').prop('disabled', true);
            
            // 生成cron表达式供测试
            const timeParts = $('#executionTime').val().split(':');
            const hours = timeParts[0];
            const minutes = timeParts[1];
            const cronExpression = `${minutes} ${hours} * * *`;  // 测试用简化表达式
            
            const taskData = {
                cron_expression: cronExpression,
                recipients: $('#recipients').val().split(',').map(e => e.trim()),
                premium_min: parseFloat($('#taskPremiumMin').val()),
                status_filter: $('#taskStatusFilter').val()
            };
            
            $.ajax({
                url: '/api/tasks/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(taskData),
                success: function(response) {
                    btn.html(originalHtml).prop('disabled', false);
                    
                    // 显示成功消息，更友好的提示
                    const modal = `
                        <div class="modal fade" id="testResultModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>测试成功</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>已成功发送测试邮件至：</p>
                                        <div class="alert alert-light">
                                            ${taskData.recipients.join('<br>')}
                                        </div>
                                        <p>筛选结果：找到 <strong>${response.filtered_count}</strong> 条符合条件的数据</p>
                                        <p class="text-muted small mt-3">请检查收件箱查看邮件内容</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('body').append(modal);
                    const testModal = new bootstrap.Modal(document.getElementById('testResultModal'));
                    testModal.show();
                    
                    // 关闭后移除
                    $('#testResultModal').on('hidden.bs.modal', function () {
                        $(this).remove();
                    });
                },
                error: function(xhr) {
                    btn.html(originalHtml).prop('disabled', false);
                    alert('测试失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        });
    </script>

    <!-- 添加Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- 自定义样式 -->
    <style>
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .toast {
            opacity: 1 !important;
        }
        
        .card-header {
            padding: 0.5rem 1rem;
        }
        
        /* 表格行间距调整 */
        .table td, .table th {
            padding: 0.5rem 0.75rem;
            vertical-align: middle;
        }
        
        /* 按钮过渡效果 */
        .btn {
            transition: all 0.2s ease-in-out;
        }
        
        /* 加载指示器效果 */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.1em;
        }
        
        /* 提示框样式 */
        .tooltip .tooltip-inner {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 4px 8px;
            font-size: 12px;
        }
    </style>
</body>
</html>
